map "http://hl7.org/fhir/StructureMap/ConceptMap2to3" = "R2 to R3 Conversions for ConceptMap"

uses "http://hl7.org/fhir/DSTU2/StructureDefinition/ConceptMap" alias ConceptMapR2 as source
uses "http://hl7.org/fhir/StructureDefinition/ConceptMap" alias ConceptMap as target

imports "http://hl7.org/fhir/StructureMap/primitives2to3"
imports "http://hl7.org/fhir/StructureMap/DomainResource2to3"
imports "http://hl7.org/fhir/StructureMap/ContactPoint2to3"
imports "http://hl7.org/fhir/StructureMap/Identifier2to3"
imports "http://hl7.org/fhir/StructureMap/Reference2to3"

group for type+types  ConceptMap extends DomainResource
  input src : ConceptMapR2 as source
  input tgt : ConceptMap as target

  "ConceptMap-url" : for src.url make tgt.url
  "ConceptMap-identifier" : for src.identifier make tgt.identifier
  "ConceptMap-version" : for src.version make tgt.version
  "ConceptMap-name" : for src.name make tgt.name
  "ConceptMap-status" : for src.status make tgt.status
  "ConceptMap-experimental" : for src.experimental make tgt.experimental
  "ConceptMap-publisher" : for src.publisher make tgt.publisher
  "ConceptMap-contact" : for src.contact as vs0 make tgt.contact as vt0 then {
    "ContactDetail-name" : for vs0.name make vt0.name
    "ContactDetail-telecom" : for vs0.telecom make vt0.telecom
  }

  "ConceptMap-date" : for src.date make tgt.date
  "ConceptMap-description" : for src.description make tgt.description
  "ConceptMap-purpose" : for src.requirements make tgt.purpose
  "ConceptMap-copyright" : for src.copyright make tgt.copyright
  "ConceptMap-jurisdiction" : for src.useContext where useContext.coding.system = 'urn:iso:std:iso:3166' make tgt.jurisdiction
  "ConceptMap-useContext" : for src.useContext as vs where (useContext.coding.system = 'urn:iso:std:iso:3166').not() make  tgt.useContext as uc,  uc.code as ucc,  ucc.system = "http://hl7.org/fhir/usage-context-type",  ucc.code = "task",  uc.value as vt then CodeableConcept(vs, vt)
  "ConceptMap-source" : for src.source make tgt.source
  "ConceptMap-target" : for src.target make tgt.target

  ConceptMap-backbone: for src.element as srcE group-by srcE.codeSystem as srcSCs
          inner srcE.target as srcT group-by srcT.codeSystem as srcTCs 
          combo make tgt.group as tgtGrp, tgtGrp.source = srcSCs, tgtGrp.target = srcTCs 
        make tgtGrp.element as tgtE then  { 
         ConceptMap-element:  for srcE.code make tgtGrp.code
         ConceptMap-target: for srcE.target as vs make tgtE.target as vt then {
           ConceptMap-target-element:  for vs.code make vt.code
           ConceptMap-target-equivalence:  for vs.equivalence make vt.equivalence
           ConceptMap-target-comments:  for vs.comments make vt.comments
           ConceptMap-target-dependsOn:  for vs.dependsOn as sd make vt.dependsOn as td then {
             ConceptMap-target-dependsOn-element: for vs.element make vt.element
             ConceptMap-target-dependsOn-codeSystem: for vs.codeSystem make vt.codeSystem
             ConceptMap-target-dependsOn-code: for vs.code make vt.code
           }  
           ConceptMap-target-product:  for vs.product as sd make vt.product as td then {
             ConceptMap-target-product-element: for vs.element make vt.element
             ConceptMap-target-product-codeSystem: for vs.codeSystem make vt.codeSystem
             ConceptMap-target-product-code: for vs.code make vt.code
           }  
         }
  }

endgroup
